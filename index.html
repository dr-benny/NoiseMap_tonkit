<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet with GeoServer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 100vh;
      }

      .leaflet-div-icon {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }

      .leaflet-popup-content {
        font-size: 14px;
      }

      /* Legend styles */
      .legend {
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      .legend h4 {
        margin-bottom: 5px;
        font-size: 16px;
      }

      .legend .color-box {
        width: 20px;
        height: 20px;
        display: inline-block;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.0/build/global/luxon.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div id="map"></div>
    <script>
      $(document).ready(function () {
        //Set start point at user location

        //BaseMap
        var terrainLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19, // OSM max zoom level is usually 19
            opacity: 0.8,
            minZoom: 5,
            attribution: "© OpenStreetMap contributors",
          }
        );
        var blackOverlay = L.rectangle(
          [
            [-90, -180],
            [90, 180],
          ], // Covers the whole world
          {
            color: "black", // Border color (optional)
            weight: 0, // No border
            fillColor: "black", // Fill color
            fillOpacity: 0.3, // Adjust darkness (0.0 = fully transparent, 1.0 = fully black)
          }
        );

        var satelliteLayer = L.tileLayer(
          "https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
          {
            maxZoom: 19,
            opacity: 0.8,
            minZoom: 5,
            subdomains: ["mt0", "mt1", "mt2", "mt3"],
            attribution: "© Google Maps",
          }
        );
        const map = L.map("map", {
          zoom: 2, // Adjust zoom level
          layers: [terrainLayer, blackOverlay],
        }).setView([13.756111, 100.516667], 13);

        // Determine marker color based on noise level
        function getMarkerColor(noiseLevel) {
          if (noiseLevel > 70) return "red";
          else if (noiseLevel > 50) return "orange";
          else return "green";
        }

        // Load GeoJSON from GeoServer
        function loadGeoJSON() {
          // fetch data
          $.ajax({
            url: "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=it.geosolutions:current_noise&outputFormat=application/json",
            method: "GET",
            success: function (data) {
              console.log(data);
              if (data && data.features) {
                L.geoJSON(data, {
                  pointToLayer: function (feature, latlng) {
                    const markerColor = getMarkerColor(
                      feature.properties.noise_level
                    );

                    const geojsonMarkerOptions = {
                      radius: 10,
                      fillColor: markerColor,
                      color: "#000",
                      weight: 1,
                      opacity: 1,
                      fillOpacity: 0.8,
                    };
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                  },
                  onEachFeature: function (feature, layer) {
                    const time = new Date(
                      feature.properties.time
                    ).toLocaleString();
                    const popupContent = `
          <div class="popup-content p-3">
              <p><span class="fw-bold">Noise Level:</span> ${feature.properties.noise_level} dB</p>
              <p><span class="fw-bold">Latest Time:</span> ${time}</p>
              <button class="btn btn-primary btn-sm popup-btn" data-id="${feature.properties.id}">More Info</button>
          </div>
      `;
                    layer.bindPopup(popupContent);
                    layer.moreInfoShow = false;
                    // Attach event listener for button
                    layer.on("popupopen", function () {
                      console.log(layer.moreInfoShow);
                      if (!layer.moreInfoShow) {
                        layer.bindPopup(popupContent);
                        $(".popup-btn").on("click", function () {
                          fetchAdditionalInfo($(this).data("id"), layer);
                        });
                      } else {
                        fetchAdditionalInfo($(this).data("id"), layer);
                      }
                    });
                  },
                }).addTo(map);
              }
            },
            error: function (error) {
              console.error("Error fetching GeoJSON:", error);
            },
          });
        }
        ////////////
        function calculateLAeq(laeq1minArray) {
          if (laeq1minArray.length === 0) return 0;

          // Compute sum of sound energy using reduce
          const sum = laeq1minArray.reduce(
            (acc, val) => acc + Math.pow(10, val / 10),
            0
          );

          // Compute mean energy and LAeq,1h
          const laeq1h = 10 * Math.log10(sum / 60);
          return parseFloat(laeq1h.toFixed(1));
        }

        // Fetch additional information and update the popup
        function fetchAdditionalInfo(id, layer) {
          console.log(layer);
          $.ajax({
            url: `http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=it.geosolutions:noise_spatial_table&outputFormat=application/json&CQL_FILTER=INTERSECTS(coordinate,POINT(${layer.feature.geometry.coordinates[0]} ${layer.feature.geometry.coordinates[1]}))&SORTBY=time+D&maxFeatures=60`,
            method: "GET",
            success: function (data) {
              const laeq1minArray = new Array(data.features.length);
              const labels = new Array(data.features.length);

              let index = data.features.length - 1;
              data.features.forEach((feature) => {
                laeq1minArray[index] = feature.properties.noise_level;
                labels[index] = new Date(
                  feature.properties.time
                ).toLocaleString();
                index--;
              });

              const additionalContent = `
              <div class="popup-content container p-3">
                <p>
                  <span class="title fw-bold">LAeq 1hr: ${calculateLAeq(
                    laeq1minArray
                  )}</span>
                  <span class="badge bg-primary" style="font-size:0.7rem">dB</span>
                </p>
                <p>
                  <span class="title fw-bold">Time:</span>
                  <span class="text-muted">${new Date(
                    layer.feature.properties.time
                  ).toLocaleString()}</span>
                </p>

                <div class="mb-3">
                  <label for="time-filter" class="form-label fw-bold">Select Time Range:</label>
                  <div class="input-group">
                    <input type="datetime-local" id="start-time" class="form-control me-2" />
                    <input type="datetime-local" id="end-time" class="form-control" />
                  </div>
                </div>

                <button id="update-chart" class="btn btn-primary w-100 my-2">Update Chart</button>

                <div class="my-3">
                  <canvas id="noiseChart" class="border rounded shadow-sm"></canvas>
                </div>

                <div class="d-flex justify-content-between">
                  <button class="popup-btn-back btn btn-secondary">Back</button>
                  <button id="downloadChart" class="btn btn-success">Download Chart</button>
                </div>
              </div>
            `;

              layer.bindPopup(additionalContent);
              layer.moreInfoShow = true;

              // Optimize chart creation
              setTimeout(() => {
                const canvas = document.getElementById("noiseChart");
                if (!canvas) return; // Prevent errors if popup closes before render

                const ctx = canvas.getContext("2d");
                layer.chartInstance = new Chart(ctx, {
                  type: "line",
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: "Noise Levels",
                        data: laeq1minArray,
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 2,
                        fill: false,
                      },
                    ],
                  },
                  options: {
                    scales: {
                      y: { beginAtZero: true },
                    },
                  },
                });
              }, 200);

              // Update chart on time range change
              $("#update-chart").on("click", function () {
                const startTime = $("#start-time").val();
                const endTime = $("#end-time").val();
                if (startTime && endTime) {
                  const filteredData = data.features.filter((feature) => {
                    const featureTime = new Date(feature.properties.time);
                    return (
                      featureTime >= new Date(startTime) &&
                      featureTime <= new Date(endTime)
                    );
                  });
                  createChart(filteredData, "noiseChart");
                } else {
                  alert("Please select both start and end times.");
                }
              });

              // Download chart functionality
              $("#downloadChart").on("click", function () {
                if (layer.chartInstance) {
                  const canvas = document.createElement("canvas");
                  const ctx = canvas.getContext("2d");
                  canvas.width = layer.chartInstance.canvas.width;
                  canvas.height = layer.chartInstance.canvas.height;

                  ctx.fillStyle = "white";
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  ctx.drawImage(layer.chartInstance.canvas, 0, 0);

                  const link = document.createElement("a");
                  link.href = canvas.toDataURL("image/png");
                  link.download = "chart.png";
                  link.click();
                } else {
                  console.error("Chart instance is not available.");
                }
              });

              // Handle back button
              $(".popup-btn-back").on("click", function () {
                const time = new Date(
                  layer.feature.properties.time
                ).toLocaleString();
                const popupContent = `
          <div class="popup-content p-3">
              <p><span class="fw-bold">Noise Level:</span> ${layer.feature.properties.noise_level} dB</p>
              <p><span class="fw-bold">Latest Time:</span> ${time}</p>
              <button class="btn btn-primary btn-sm popup-btn" data-id="${layer.feature.properties.id}">More Info</button>
          </div>
      `;

                layer.closePopup();
                layer.chartInstance.destroy();
                layer.moreInfoShow = false;
                setTimeout(() => {
                  layer.bindPopup(popupContent); // Bind new content
                  layer.openPopup(); // Open the popup
                }, 100);
              });
            },
            error: function (error) {
              console.error("Error fetching additional info:", error);
            },
          });
        }

        loadGeoJSON();

        // Add legend
        var legend = L.control({ position: "bottomleft" });
        legend.onAdd = function () {
          var div = L.DomUtil.create("div", "legend");
          div.innerHTML = `
        <div class="legend p-3 border rounded shadow-sm bg-light">
          <h4 class="fw-bold mb-3">Noise Level Legend</h4>
          <p class="d-flex align-items-center">
            <span class="color-box me-2" style="background-color:#FF0000; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span>
            <span class="text-danger fw-bold">High (70+ dB)</span>
          </p>
          <p class="d-flex align-items-center">
            <span class="color-box me-2" style="background-color:#FFA500; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span>
            <span class="text-warning fw-bold">Medium (50-69 dB)</span>
          </p>
          <p class="d-flex align-items-center">
            <span class="color-box me-2" style="background-color:#008000; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span>
            <span class="text-success fw-bold">Low (below 50 dB)</span>
          </p>
        </div>
      `;

          return div;
        };
        legend.addTo(map);

        // Layer controls
        var baseLayers = {
          Terrain: terrainLayer,
          Satellite: satelliteLayer,
        };
        L.control.layers(baseLayers).addTo(map);
      });
    </script>
  </body>
</html>
