<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaflet with GeoServer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 100vh;
      }

      .leaflet-div-icon {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }

      .leaflet-popup-content {
        font-size: 14px;
      }

      /* Legend styles */
      .legend {
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      .legend h4 {
        margin-bottom: 5px;
        font-size: 16px;
      }

      .legend .color-box {
        width: 20px;
        height: 20px;
        display: inline-block;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.0/build/global/luxon.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div id="map"></div>
    <script>
      $(document).ready(function () {
        //Set start point at user location
        const map = L.map("map").setView([13.756111, 100.516667], 13);

        //BaseMap
        var terrainLayer = L.tileLayer(
          "https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",
          {
            maxZoom: 20,
            subdomains: ["mt0", "mt1", "mt2", "mt3"],
            attribution: "© Google Maps",
          }
        );

        var satelliteLayer = L.tileLayer(
          "https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
          {
            maxZoom: 20,
            subdomains: ["mt0", "mt1", "mt2", "mt3"],
            attribution: "© Google Maps",
          }
        );
        terrainLayer.addTo(map);

        // Determine marker color based on noise level
        function getMarkerColor(noiseLevel) {
          if (noiseLevel > 70) return "red";
          else if (noiseLevel > 50) return "orange";
          else return "green";
        }

        // Load GeoJSON from GeoServer
        function loadGeoJSON() {
          $.ajax({
            url: "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=it.geosolutions:current_noise&outputFormat=application/json",
            method: "GET",
            success: function (data) {
              if (data && data.features) {
                L.geoJSON(data, {
                  pointToLayer: function (feature, latlng) {
                    const markerColor = getMarkerColor(
                      feature.properties.noise_level
                    );

                    const geojsonMarkerOptions = {
                      radius: 10,
                      fillColor: markerColor,
                      color: "#000",
                      weight: 1,
                      opacity: 1,
                      fillOpacity: 0.8,
                    };
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                  },
                  onEachFeature: function (feature, layer) {
                    let moreInfoShow = false;
                    const time = new Date(
                      feature.properties.time
                    ).toLocaleString();
                    const popupContent = `
    <div class="popup-content p-3">
        <p><span class="fw-bold">Noise Level:</span> ${feature.properties.noise_level} dB</p>
        <p><span class="fw-bold">Latest Time:</span> ${time}</p>
        <button class="btn btn-primary btn-sm popup-btn" data-id="${feature.properties.id}">More Info</button>
    </div>
`;
                    layer.bindPopup(popupContent);

                    // Attach event listener for button
                    layer.on("popupopen", function () {
                      console.log(moreInfoShow);
                      if (!moreInfoShow) {
                        layer.bindPopup(popupContent);
                        $(".popup-btn").on("click", function () {
                          fetchAdditionalInfo($(this).data("id"), layer);
                        });
                      } else {
                        fetchAdditionalInfo($(this).data("id"), layer);
                      }
                    });
                  },
                }).addTo(map);
              }
            },
            error: function (error) {
              console.error("Error fetching GeoJSON:", error);
            },
          });
        }

        // Fetch additional information and update the popup
        function fetchAdditionalInfo(id, layer) {
          console.log(layer);
          $.ajax({
            url: `http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=it.geosolutions:noise_spatial_table&outputFormat=application/json&CQL_FILTER=INTERSECTS(coordinate,POINT(${layer.feature.geometry.coordinates[0]} ${layer.feature.geometry.coordinates[1]}))&SORTBY=time`,
            method: "GET",
            success: async function (data) {
              const additionalContent = `
        <div class="popup-content container p-3">
          <p>
            <span class="title fw-bold">Noise Level:</span> 
            <span class="badge bg-primary" style="font-size:0.7rem">${
              data.features[0].properties.noise_level
            } dB</span>
          </p>
          <p>
            <span class="title fw-bold">Time:</span> 
            <span class="text-muted">${new Date(
              layer.feature.properties.time
            ).toLocaleString()}</span>
          </p>

          <div class="mb-3">
            <label for="time-filter" class="form-label fw-bold">Select Time Range:</label>
            <div class="input-group">
              <input type="datetime-local" id="start-time" class="form-control me-2" />
              <input type="datetime-local" id="end-time" class="form-control" />
            </div>
          </div>

          <button id="update-chart" class="btn btn-primary w-100 my-2">Update Chart</button>

          <div class="my-3">
            <canvas id="noiseChart" class="border rounded shadow-sm"></canvas>
          </div>

          <div class="d-flex justify-content-between">
            <button class="popup-btn-back btn btn-secondary">Back</button>
            <button id="downloadChart" class="btn btn-success">Download Chart</button>
          </div>
        </div>
      `;
              //layer.setPopupContent(additionalContent).openPopup();
              layer.bindPopup(additionalContent);

              moreInfoShow = true;
              layer.on("popupclose", function () {
                layer.chartInstance.destroy();
              });
              async function createChart(features, chartId) {
                console.log("create");
                const ctx = document.getElementById(chartId).getContext("2d");
                const labels = [];
                const noiseLevels = [];

                features.forEach((feature) => {
                  labels.push(
                    new Date(feature.properties.time).toLocaleString()
                  );
                  noiseLevels.push(feature.properties.noise_level);
                });

                layer.chartInstance = new Chart(ctx, {
                  type: "line",
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: "Noise Levels",
                        data: noiseLevels,
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 2,
                        fill: false,
                      },
                    ],
                  },
                  options: {
                    scales: {
                      y: {
                        beginAtZero: true,
                      },
                    },
                  },
                });
              }
              setTimeout(() => {
                createChart(data.features, "noiseChart");
              }, 300);

              // Update chart on time range change
              $("#update-chart").on("click", function () {
                const startTime = $("#start-time").val();
                const endTime = $("#end-time").val();
                if (startTime && endTime) {
                  const filteredData = data.features.filter((feature) => {
                    const featureTime = new Date(feature.properties.time);
                    return (
                      featureTime >= new Date(startTime) &&
                      featureTime <= new Date(endTime)
                    );
                  });
                  createChart(filteredData, "noiseChart");
                } else {
                  alert("Please select both start and end times.");
                }
              });

              // Download chart functionality
              $("#downloadChart").on("click", function () {
                if (layer.chartInstance) {
                  const canvas = document.createElement("canvas");
                  const ctx = canvas.getContext("2d");
                  canvas.width = layer.chartInstance.canvas.width;
                  canvas.height = layer.chartInstance.canvas.height;

                  ctx.fillStyle = "white";
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  ctx.drawImage(layer.chartInstance.canvas, 0, 0);

                  const link = document.createElement("a");
                  link.href = canvas.toDataURL("image/png");
                  link.download = "chart.png";
                  link.click();
                } else {
                  console.error("Chart instance is not available.");
                }
              });

              // Handle back button
              $(".popup-btn-back").on("click", function () {
                const time = new Date(
                  layer.feature.properties.time
                ).toLocaleString();
                const popupContent = `
    <div class="popup-content p-3">
        <p><span class="fw-bold">Noise Level:</span> ${layer.feature.properties.noise_level} dB</p>
        <p><span class="fw-bold">Latest Time:</span> ${time}</p>
        <button class="btn btn-primary btn-sm popup-btn" data-id="${layer.feature.properties.id}">More Info</button>
    </div>
`;

                layer.closePopup();
                layer.chartInstance.destroy();
                moreInfoShow = false;
                setTimeout(() => {
                  layer.bindPopup(popupContent); // Bind new content
                  layer.openPopup(); // Open the popup
                }, 100);
              });
            },
            error: function (error) {
              console.error("Error fetching additional info:", error);
            },
          });
        }

        loadGeoJSON();

        // Add legend
        var legend = L.control({ position: "bottomleft" });
        legend.onAdd = function () {
          var div = L.DomUtil.create("div", "legend");
          div.innerHTML = `
  <div class="legend p-3 border rounded shadow-sm bg-light">
    <h4 class="fw-bold mb-3">Noise Level Legend</h4>
    <p class="d-flex align-items-center">
      <span class="color-box me-2" style="background-color:#FF0000; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span> 
      <span class="text-danger fw-bold">High (70+ dB)</span>
    </p>
    <p class="d-flex align-items-center">
      <span class="color-box me-2" style="background-color:#FFA500; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span> 
      <span class="text-warning fw-bold">Medium (50-69 dB)</span>
    </p>
    <p class="d-flex align-items-center">
      <span class="color-box me-2" style="background-color:#008000; width: 20px; height: 20px; display: inline-block; border-radius: 4px;"></span> 
      <span class="text-success fw-bold">Low (below 50 dB)</span>
    </p>
  </div>
`;

          return div;
        };
        legend.addTo(map);

        // Layer controls
        var baseLayers = {
          Terrain: terrainLayer,
          Satellite: satelliteLayer,
        };
        L.control.layers(baseLayers).addTo(map);
      });
    </script>
  </body>
</html>
